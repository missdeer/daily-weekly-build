name: GNB for macOS.Intel and MacOS.Apple_Silicon

on:
  push:
    paths:
      - '.github/workflows/opengnb-darwin.yaml'
  pull_request:
    paths:
      - '.github/workflows/opengnb-darwin.yaml'

jobs:
  build_and_publish_opengnb:
    runs-on: macos-latest  # GitHub æä¾›çš„ macOS è¿è¡Œç¯å¢ƒï¼ˆé»˜è®¤ arm64ï¼‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          repository: gnbdev/opengnb
          ref: master

      - name: Install dependencies
        run: |
          brew install cmake ninja

      - name: Modify Makefile for static linking
        run: |
          echo "ğŸ”§ ä¿®æ”¹ Makefile.Darwin ä»¥å¼ºåˆ¶ä½¿ç”¨é™æ€åº“..."
          sed -i '' 's|-static||g' Makefile.Darwin
          sed -i '' 's|-lssl|-l:libssl.a|g' Makefile.Darwin
          sed -i '' 's|-lcrypto|-l:libcrypto.a|g' Makefile.Darwin
          sed -i '' 's|-lz|-l:libz.a|g' Makefile.Darwin
          echo "âœ… Makefile.Darwin ä¿®æ”¹å®Œæˆï¼"

      # ç¼–è¯‘ x86_64 ç‰ˆæœ¬
      - name: Build binary for x86_64
        run: |
          export CC="clang -arch x86_64"
          export CXX="clang++ -arch x86_64"
          export LD="ld"
          export AR="ar"
          export RANLIB="ranlib"

          make -f Makefile.Darwin clean
          make -f Makefile.Darwin install

          # æ£€æŸ¥æ˜¯å¦ä»ç„¶é“¾æ¥åŠ¨æ€åº“
          echo "ğŸ” æ£€æŸ¥ x86_64 ç‰ˆæœ¬æ˜¯å¦åŒ…å«åŠ¨æ€åº“..."
          if otool -L bin/gnb | grep -q ".dylib"; then
            echo "âŒ ä»ç„¶ä¾èµ–åŠ¨æ€åº“ï¼"
            #exit 1
          else
            echo "âœ… x86_64 ç‰ˆæœ¬å®Œå…¨é™æ€ï¼"
          fi

          # æ‰“åŒ… x86_64 ç‰ˆæœ¬
          mkdir -p release/macos_x86_64
          cp -r bin release/macos_x86_64/

      # ç¼–è¯‘ arm64 ç‰ˆæœ¬
      - name: Build binary for arm64
        run: |
          export CC="clang -arch arm64"
          export CXX="clang++ -arch arm64"
          export LD="ld"
          export AR="ar"
          export RANLIB="ranlib"

          make -f Makefile.Darwin clean
          make -f Makefile.Darwin install

          # æ£€æŸ¥æ˜¯å¦ä»ç„¶é“¾æ¥åŠ¨æ€åº“
          echo "ğŸ” æ£€æŸ¥ arm64 ç‰ˆæœ¬æ˜¯å¦åŒ…å«åŠ¨æ€åº“..."
          if otool -L bin/gnb | grep -q ".dylib"; then
            echo "âŒ ä»ç„¶ä¾èµ–åŠ¨æ€åº“ï¼"
            #exit 1
          else
            echo "âœ… arm64 ç‰ˆæœ¬å®Œå…¨é™æ€ï¼"
          fi

          # æ‰“åŒ… arm64 ç‰ˆæœ¬
          mkdir -p release/macos_arm64
          cp -r bin release/macos_arm64/

      - name: lipo to make FAT binary
        run: |
          mkdir -p release/universal
          lipo -create -output release/universal/gnb release/macos_x86_64/bin/gnb release/macos_arm64/bin/gnb
          lipo -create -output release/universal/gnb_ctl release/macos_x86_64/bin/gnb_ctl release/macos_arm64/bin/gnb_ctl
          lipo -create -output release/universal/gnb_crypto release/macos_x86_64/bin/gnb_crypto release/macos_arm64/bin/gnb_crypto
          lipo -create -output release/universal/gnb_es release/macos_x86_64/bin/gnb_es release/macos_arm64/bin/gnb_es
          
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: opengnb-macos-universal.zip
          path: release/universal
